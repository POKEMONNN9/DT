<!DOCTYPE html>
<html>
<head>
    <title>Real Filter Test - Using Actual JavaScript Logic</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { margin: 5px; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .filter-test { margin: 10px 0; }
        .filter-test input, .filter-test select { margin: 5px; padding: 5px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .finding-row { margin: 5px 0; padding: 5px; border: 1px solid #eee; }
        .finding-id { font-weight: bold; color: #333; }
        .finding-data { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <h1>Real Filter Test - Using Actual JavaScript Logic</h1>
    
    <div class="test-section">
        <h2>Findings Data (from findings.json)</h2>
        <div id="findings-display"></div>
    </div>
    
    <div class="test-section">
        <h2>Comprehensive Filter Tests</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Manual Filter Test</h2>
        <div class="filter-test">
            <label>Parameter:</label>
            <select id="test-param">
                <option value="status">status</option>
                <option value="domain_name">domain_name</option>
                <option value="risk_score">risk_score</option>
                <option value="tags">tags</option>
                <option value="name_servers_data">name_servers_data</option>
                <option value="mail_servers_data">mail_servers_data</option>
                <option value="asrm_triggered">asrm_triggered</option>
                <option value="asrm_rule_applied">asrm_rule_applied</option>
                <option value="admin_contact.country">admin_contact.country</option>
            </select>
            
            <label>Operator:</label>
            <select id="test-operator">
                <option value="equals">equals</option>
                <option value="not_equals">not equals</option>
                <option value="contains">contains</option>
                <option value="not_contains">not contains</option>
                <option value="greater_than">greater than</option>
                <option value="less_than">less than</option>
                <option value="starts_with">starts with</option>
                <option value="ends_with">ends with</option>
                <option value="regex">regex</option>
            </select>
            
            <label>Value:</label>
            <input type="text" id="test-value" placeholder="Enter test value">
            
            <button onclick="runManualTest()">Test Filter</button>
        </div>
        <div id="manual-test-result"></div>
    </div>

    <script>
        // Load findings data from findings.json
        window.findingsData = {{ findings|tojson }};
        
        // Copy the EXACT JavaScript filtering logic from dtmonitor-findings.js
        function evaluateDynamicFilter(finding, param, operator, value) {
            // Define parameter types (exact copy from dtmonitor-findings.js)
            const numericParams = ['risk_score', 'ip_asn', 'response_code', 'threat_profile.phishing.score', 'threat_profile.malware.score', 'threat_profile.spam.score'];
            const booleanParams = ['is_active', 'asrm_triggered', 'pl_submission'];
            const dateParams = ['discovered_at', 'first_seen', 'create_date', 'expiration_date'];
            const arrayParams = ['tags'];
            const complexArrayParams = ['name_servers_data', 'mail_servers_data'];
            
            // Get the value from the finding (exact copy from dtmonitor-findings.js)
            let findingValue = null;
            
            if (param.includes('.')) {
                // Handle nested fields
                const keys = param.split('.');
                let nestedValue = finding;
                for (const key of keys) {
                    if (nestedValue && typeof nestedValue === 'object') {
                        nestedValue = nestedValue[key];
                    } else {
                        nestedValue = null;
                        break;
                    }
                }
                findingValue = nestedValue;
            } else {
                findingValue = finding[param];
            }
            
            if (findingValue === null || findingValue === undefined) {
                return false;
            }
            
            // Convert value based on parameter type (exact copy from dtmonitor-findings.js)
            let convertedFindingValue = findingValue;
            let convertedFilterValue = value;
            
            if (numericParams.includes(param)) {
                convertedFindingValue = parseFloat(findingValue);
                convertedFilterValue = parseFloat(value);
                
                if (isNaN(convertedFindingValue) || isNaN(convertedFilterValue)) {
                    return false;
                }
            } else if (booleanParams.includes(param)) {
                // Handle boolean conversion more robustly
                // HTML data attributes store booleans as strings
                convertedFindingValue = String(findingValue).toLowerCase() === 'true' || findingValue === true || findingValue === 1;
                convertedFilterValue = String(value).toLowerCase() === 'true' || value === true || value === 1;
            } else if (dateParams.includes(param)) {
                // Handle date comparison
                const findingDate = new Date(findingValue);
                const filterDate = new Date(value);
                
                if (isNaN(findingDate.getTime()) || isNaN(filterDate.getTime())) {
                    return false;
                }
                
                // Compare dates (ignore time)
                const findingDateOnly = new Date(findingDate.getFullYear(), findingDate.getMonth(), findingDate.getDate());
                const filterDateOnly = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate());
                
                convertedFindingValue = findingDateOnly.getTime();
                convertedFilterValue = filterDateOnly.getTime();
            } else if (arrayParams.includes(param)) {
                // Handle simple array parameters (like tags)
                if (Array.isArray(findingValue)) {
                    convertedFindingValue = findingValue;
                } else {
                    convertedFindingValue = [];
                }
                convertedFilterValue = value;
            } else if (complexArrayParams.includes(param)) {
                // Handle complex array parameters (like name_servers_data, mail_servers_data)
                // Data is already parsed from JavaScript variable
                if (Array.isArray(findingValue)) {
                    convertedFindingValue = findingValue;
                } else {
                    convertedFindingValue = [];
                }
                convertedFilterValue = value;
            } else {
                // Handle string parameters
                convertedFindingValue = String(findingValue).toLowerCase();
                convertedFilterValue = String(value).toLowerCase();
            }
            
            // Apply operator (exact copy from dtmonitor-findings.js)
            switch (operator) {
                case 'equals':
                    if (arrayParams.includes(param)) {
                        return convertedFindingValue.includes(convertedFilterValue);
                    } else if (complexArrayParams.includes(param)) {
                        return convertedFindingValue.some(server => {
                            // Check if any server object has a property that exactly matches (case-insensitive)
                            return Object.values(server).some(prop => 
                                String(prop).toLowerCase() === convertedFilterValue.toLowerCase()
                            );
                        });
                    }
                    return convertedFindingValue === convertedFilterValue;
                case 'not_equals':
                    if (arrayParams.includes(param)) {
                        return !convertedFindingValue.includes(convertedFilterValue);
                    } else if (complexArrayParams.includes(param)) {
                        return !convertedFindingValue.some(server => {
                            // Check if any server object has a property that exactly matches (case-insensitive)
                            return Object.values(server).some(prop => 
                                String(prop).toLowerCase() === convertedFilterValue.toLowerCase()
                            );
                        });
                    }
                    return convertedFindingValue !== convertedFilterValue;
                case 'contains':
                    if (arrayParams.includes(param)) {
                        return convertedFindingValue.some(item => 
                            String(item).toLowerCase().includes(convertedFilterValue.toLowerCase())
                        );
                    } else if (complexArrayParams.includes(param)) {
                        return convertedFindingValue.some(server => {
                            // Search in all properties of the server object
                            return Object.values(server).some(prop =>
                                String(prop).toLowerCase().includes(convertedFilterValue.toLowerCase())
                            );
                        });
                    }
                    return convertedFindingValue.includes(convertedFilterValue);
                case 'not_contains':
                    if (arrayParams.includes(param)) {
                        return !convertedFindingValue.some(item => 
                            String(item).toLowerCase().includes(convertedFilterValue.toLowerCase())
                        );
                    } else if (complexArrayParams.includes(param)) {
                        return !convertedFindingValue.some(server => {
                            // Search in all properties of the server object
                            return Object.values(server).some(prop =>
                                String(prop).toLowerCase().includes(convertedFilterValue.toLowerCase())
                            );
                        });
                    }
                    return !convertedFindingValue.includes(convertedFilterValue);
                case 'greater_than':
                    return convertedFindingValue > convertedFilterValue;
                case 'less_than':
                    return convertedFindingValue < convertedFilterValue;
                case 'starts_with':
                    if (complexArrayParams.includes(param)) {
                        return convertedFindingValue.some(server => {
                            return Object.values(server).some(prop => 
                                String(prop).toLowerCase().startsWith(convertedFilterValue.toLowerCase())
                            );
                        });
                    }
                    return convertedFindingValue.startsWith(convertedFilterValue);
                case 'ends_with':
                    if (complexArrayParams.includes(param)) {
                        return convertedFindingValue.some(server => {
                            return Object.values(server).some(prop => 
                                String(prop).toLowerCase().endsWith(convertedFilterValue.toLowerCase())
                            );
                        });
                    }
                    return convertedFindingValue.endsWith(convertedFilterValue);
                case 'regex':
                    try {
                        const regex = new RegExp(convertedFilterValue, 'i');
                        if (complexArrayParams.includes(param)) {
                            return convertedFindingValue.some(server => {
                                return Object.values(server).some(prop =>
                                    regex.test(String(prop))
                                );
                            });
                        }
                        return regex.test(convertedFindingValue);
                    } catch (e) {
                        return false;
                    }
                default:
                    return false;
            }
        }
        
        function displayFindings() {
            const container = document.getElementById('findings-display');
            const findings = window.findingsData || [];
            
            let html = `<h3>Found ${findings.length} findings from findings.json:</h3>`;
            
            findings.forEach(finding => {
                html += `<div class="finding-row">
                    <div class="finding-id">${finding.id}</div>
                    <div class="finding-data">
                        Status: ${finding.status || 'N/A'} | 
                        Domain: ${finding.domain_name || 'N/A'} | 
                        Risk: ${finding.risk_score || 'N/A'} | 
                        Tags: ${finding.tags ? finding.tags.join(', ') : 'N/A'} |
                        ASRM: ${finding.asrm_triggered || 'N/A'} |
                        ASRM Rule: ${finding.asrm_rule_applied || 'N/A'}
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function runAllTests() {
            const container = document.getElementById('test-results');
            container.innerHTML = '<div class="test-result info">Running comprehensive tests...</div>';
            
            const findings = window.findingsData || [];
            const tests = [
                { name: 'Status equals approved', param: 'status', operator: 'equals', value: 'approved', expected: 3 },
                { name: 'Status equals rejected', param: 'status', operator: 'equals', value: 'rejected', expected: 2 },
                { name: 'Risk score greater than 50', param: 'risk_score', operator: 'greater_than', value: '50', expected: 5 },
                { name: 'Tags contains phishing', param: 'tags', operator: 'contains', value: 'phishing', expected: 2 },
                { name: 'Name servers equals ns1.cloudflare.com', param: 'name_servers_data', operator: 'equals', value: 'ns1.cloudflare.com', expected: 1 },
                { name: 'Mail servers equals mail.legitimate-business.com', param: 'mail_servers_data', operator: 'equals', value: 'mail.legitimate-business.com', expected: 1 },
                { name: 'ASRM triggered equals true', param: 'asrm_triggered', operator: 'equals', value: 'true', expected: 2 },
                { name: 'ASRM rule applied equals banking_phish_rule', param: 'asrm_rule_applied', operator: 'equals', value: 'banking_phish_rule', expected: 1 },
                { name: 'ASRM rule applied equals rule_001', param: 'asrm_rule_applied', operator: 'equals', value: 'rule_001', expected: 1 },
                { name: 'ASRM rule applied equals Expired Domains (should fail)', param: 'asrm_rule_applied', operator: 'equals', value: 'Expired Domains', expected: 0 }
            ];
            
            let html = '';
            let passed = 0;
            
            tests.forEach(test => {
                let matches = 0;
                const matchingFindings = [];
                
                findings.forEach(finding => {
                    if (evaluateDynamicFilter(finding, test.param, test.operator, test.value)) {
                        matches++;
                        matchingFindings.push(finding.id);
                    }
                });
                
                const testPassed = matches === test.expected;
                if (testPassed) passed++;
                
                html += `<div class="test-result ${testPassed ? 'pass' : 'fail'}">
                    <strong>${test.name}</strong><br>
                    Parameter: ${test.param} | Operator: ${test.operator} | Value: "${test.value}"<br>
                    Expected: ${test.expected} | Got: ${matches} ${testPassed ? '✅' : '❌'}<br>
                    Matching findings: ${matchingFindings.join(', ')}
                </div>`;
            });
            
            html += `<div class="test-result info">
                <strong>SUMMARY: ${passed}/${tests.length} tests passed</strong>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function runManualTest() {
            const param = document.getElementById('test-param').value;
            const operator = document.getElementById('test-operator').value;
            const value = document.getElementById('test-value').value;
            
            if (!param || !value) {
                alert('Please select a parameter and enter a value');
                return;
            }
            
            const findings = window.findingsData || [];
            let matches = 0;
            const matchingFindings = [];
            
            findings.forEach(finding => {
                if (evaluateDynamicFilter(finding, param, operator, value)) {
                    matches++;
                    matchingFindings.push(finding.id);
                }
            });
            
            const resultDiv = document.getElementById('manual-test-result');
            resultDiv.innerHTML = `
                <div class="test-result ${matches > 0 ? 'pass' : 'fail'}">
                    <strong>Manual Filter Test Result:</strong><br>
                    Parameter: ${param} | Operator: ${operator} | Value: "${value}"<br>
                    Matches: ${matches} out of ${findings.length} findings<br>
                    Matching findings: ${matchingFindings.join(', ')}<br>
                    ${matches > 0 ? '✅ PASS' : '❌ FAIL'}
                </div>
            `;
        }
        
        // Initialize
        window.onload = function() {
            displayFindings();
            runAllTests();
        };
    </script>
</body>
</html>
