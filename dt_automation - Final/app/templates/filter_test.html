<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter Test Page</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { margin: 5px; padding: 8px 15px; }
        .filter-test { margin: 10px 0; }
        .filter-test input, .filter-test select { margin: 5px; padding: 5px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Dynamic Filter Test Page</h1>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Available Findings Data</h2>
        <div id="findings-data"></div>
    </div>
    
    <div class="test-section">
        <h2>Filter Tests</h2>
        <div id="filter-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>Manual Filter Test</h2>
        <div class="filter-test">
            <label>Parameter:</label>
            <select id="test-param">
                <option value="status">Status</option>
                <option value="domain_name">Domain Name</option>
                <option value="risk_score">Risk Score</option>
                <option value="tags">Tags</option>
                <option value="name_servers_data">Name Servers Data</option>
                <option value="mail_servers_data">Mail Servers Data</option>
                <option value="is_active">Is Active</option>
                <option value="asrm_triggered">ASRM Triggered</option>
                <option value="admin_contact.country">Admin Country</option>
            </select>
            
            <label>Operator:</label>
            <select id="test-operator">
                <option value="equals">equals</option>
                <option value="not_equals">not equals</option>
                <option value="contains">contains</option>
                <option value="not_contains">not contains</option>
                <option value="greater_than">greater than</option>
                <option value="less_than">less than</option>
                <option value="starts_with">starts with</option>
                <option value="ends_with">ends with</option>
                <option value="regex">regex</option>
            </select>
            
            <label>Value:</label>
            <input type="text" id="test-value" placeholder="Enter test value">
            
            <button onclick="runManualTest()">Test Filter</button>
        </div>
        <div id="manual-test-result"></div>
    </div>

    <script>
        // Load findings data
        window.findingsData = {{ findings|tojson }};
        
        function addResult(message, type = 'info') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }
        
        function showFindingsData() {
            const container = document.getElementById('findings-data');
            const findings = window.findingsData || [];
            
            let html = `<h3>Found ${findings.length} findings:</h3>`;
            html += '<table><tr><th>ID</th><th>Domain</th><th>Status</th><th>Risk Score</th><th>Tags</th><th>Name Servers</th><th>Mail Servers</th></tr>';
            
            findings.forEach(finding => {
                const nameServers = finding.name_servers_data ? finding.name_servers_data.map(s => s.host).join(', ') : 'None';
                const mailServers = finding.mail_servers_data ? finding.mail_servers_data.map(s => s.host).join(', ') : 'None';
                const tags = finding.tags ? finding.tags.join(', ') : 'None';
                
                html += `<tr>
                    <td>${finding.id}</td>
                    <td>${finding.domain_name || 'N/A'}</td>
                    <td>${finding.status || 'N/A'}</td>
                    <td>${finding.risk_score || 'N/A'}</td>
                    <td>${tags}</td>
                    <td>${nameServers}</td>
                    <td>${mailServers}</td>
                </tr>`;
            });
            
            html += '</table>';
            container.innerHTML = html;
        }
        
        function runFilterTest(param, operator, value) {
            const findings = window.findingsData || [];
            let matches = 0;
            let total = findings.length;
            
            findings.forEach(finding => {
                if (evaluateFilter(finding, param, operator, value)) {
                    matches++;
                }
            });
            
            return { matches, total };
        }
        
        function evaluateFilter(finding, param, operator, value) {
            // Get the value from the finding
            let findingValue = null;
            
            if (param.includes('.')) {
                // Handle nested fields
                const keys = param.split('.');
                let nestedValue = finding;
                for (const key of keys) {
                    if (nestedValue && typeof nestedValue === 'object') {
                        nestedValue = nestedValue[key];
                    } else {
                        nestedValue = null;
                        break;
                    }
                }
                findingValue = nestedValue;
            } else {
                findingValue = finding[param];
            }
            
            if (findingValue === null || findingValue === undefined) {
                return false;
            }
            
            // Convert values based on type
            const numericParams = ['risk_score', 'ip_asn', 'response_code'];
            const booleanParams = ['is_active', 'asrm_triggered', 'pl_submission'];
            const arrayParams = ['tags'];
            const complexArrayParams = ['name_servers_data', 'mail_servers_data'];
            
            let convertedFindingValue = findingValue;
            let convertedFilterValue = value;
            
            if (numericParams.includes(param)) {
                convertedFindingValue = Number(findingValue);
                convertedFilterValue = Number(value);
            } else if (booleanParams.includes(param)) {
                convertedFindingValue = Boolean(findingValue);
                convertedFilterValue = value === 'true' || value === 'True' || value === '1';
            } else if (arrayParams.includes(param)) {
                if (Array.isArray(findingValue)) {
                    convertedFindingValue = findingValue;
                } else {
                    convertedFindingValue = [];
                }
                convertedFilterValue = value;
            } else if (complexArrayParams.includes(param)) {
                if (Array.isArray(findingValue)) {
                    convertedFindingValue = findingValue;
                } else {
                    convertedFindingValue = [];
                }
                convertedFilterValue = value;
            } else {
                convertedFindingValue = String(findingValue).toLowerCase();
                convertedFilterValue = String(value).toLowerCase();
            }
            
            // Apply operator
            switch (operator) {
                case 'equals':
                    if (arrayParams.includes(param)) {
                        return convertedFindingValue.includes(convertedFilterValue);
                    } else if (complexArrayParams.includes(param)) {
                        return convertedFindingValue.some(server => {
                            return Object.values(server).some(prop => 
                                String(prop).toLowerCase() === convertedFilterValue.toLowerCase()
                            );
                        });
                    }
                    return convertedFindingValue === convertedFilterValue;
                case 'not_equals':
                    if (arrayParams.includes(param)) {
                        return !convertedFindingValue.includes(convertedFilterValue);
                    } else if (complexArrayParams.includes(param)) {
                        return !convertedFindingValue.some(server => {
                            return Object.values(server).some(prop => 
                                String(prop).toLowerCase() === convertedFilterValue.toLowerCase()
                            );
                        });
                    }
                    return convertedFindingValue !== convertedFilterValue;
                case 'contains':
                    if (arrayParams.includes(param)) {
                        return convertedFindingValue.some(item => 
                            String(item).toLowerCase().includes(convertedFilterValue.toLowerCase())
                        );
                    } else if (complexArrayParams.includes(param)) {
                        return convertedFindingValue.some(server => {
                            return Object.values(server).some(prop =>
                                String(prop).toLowerCase().includes(convertedFilterValue.toLowerCase())
                            );
                        });
                    }
                    return convertedFindingValue.includes(convertedFilterValue);
                case 'not_contains':
                    if (arrayParams.includes(param)) {
                        return !convertedFindingValue.some(item => 
                            String(item).toLowerCase().includes(convertedFilterValue.toLowerCase())
                        );
                    } else if (complexArrayParams.includes(param)) {
                        return !convertedFindingValue.some(server => {
                            return Object.values(server).some(prop =>
                                String(prop).toLowerCase().includes(convertedFilterValue.toLowerCase())
                            );
                        });
                    }
                    return !convertedFindingValue.includes(convertedFilterValue);
                case 'greater_than':
                    return convertedFindingValue > convertedFilterValue;
                case 'less_than':
                    return convertedFindingValue < convertedFilterValue;
                case 'starts_with':
                    if (complexArrayParams.includes(param)) {
                        return convertedFindingValue.some(server => {
                            return Object.values(server).some(prop => 
                                String(prop).toLowerCase().startsWith(convertedFilterValue.toLowerCase())
                            );
                        });
                    }
                    return convertedFindingValue.startsWith(convertedFilterValue);
                case 'ends_with':
                    if (complexArrayParams.includes(param)) {
                        return convertedFindingValue.some(server => {
                            return Object.values(server).some(prop => 
                                String(prop).toLowerCase().endsWith(convertedFilterValue.toLowerCase())
                            );
                        });
                    }
                    return convertedFindingValue.endsWith(convertedFilterValue);
                case 'regex':
                    try {
                        const regex = new RegExp(convertedFilterValue, 'i');
                        if (complexArrayParams.includes(param)) {
                            return convertedFindingValue.some(server => {
                                return Object.values(server).some(prop =>
                                    regex.test(String(prop))
                                );
                            });
                        }
                        return regex.test(convertedFindingValue);
                    } catch (e) {
                        return false;
                    }
                default:
                    return false;
            }
        }
        
        function runManualTest() {
            const param = document.getElementById('test-param').value;
            const operator = document.getElementById('test-operator').value;
            const value = document.getElementById('test-value').value;
            
            const result = runFilterTest(param, operator, value);
            const resultDiv = document.getElementById('manual-test-result');
            
            resultDiv.innerHTML = `
                <div class="test-result ${result.matches > 0 ? 'pass' : 'fail'}">
                    <strong>Filter Test Result:</strong><br>
                    Parameter: ${param}<br>
                    Operator: ${operator}<br>
                    Value: ${value}<br>
                    Matches: ${result.matches} out of ${result.total} findings
                </div>
            `;
        }
        
        function runAllTests() {
            clearResults();
            addResult('Starting comprehensive filter tests...', 'info');
            
            // Test 1: Basic string filters
            addResult('\\n=== Testing Basic String Filters ===', 'info');
            
            // Status filter
            const statusResult = runFilterTest('status', 'equals', 'approved');
            addResult(`Status equals 'approved': ${statusResult.matches}/${statusResult.total}`, 
                     statusResult.matches > 0 ? 'pass' : 'fail');
            
            // Domain name filter
            const domainResult = runFilterTest('domain_name', 'contains', 'legitimate');
            addResult(`Domain name contains 'legitimate': ${domainResult.matches}/${domainResult.total}`, 
                     domainResult.matches > 0 ? 'pass' : 'fail');
            
            // Test 2: Numeric filters
            addResult('\\n=== Testing Numeric Filters ===', 'info');
            
            const riskResult = runFilterTest('risk_score', 'greater_than', '50');
            addResult(`Risk score > 50: ${riskResult.matches}/${riskResult.total}`, 
                     riskResult.matches > 0 ? 'pass' : 'fail');
            
            // Test 3: Array filters
            addResult('\\n=== Testing Array Filters ===', 'info');
            
            const tagsResult = runFilterTest('tags', 'contains', 'phishing');
            addResult(`Tags contains 'phishing': ${tagsResult.matches}/${tagsResult.total}`, 
                     tagsResult.matches > 0 ? 'pass' : 'fail');
            
            // Test 4: Complex array filters
            addResult('\\n=== Testing Complex Array Filters ===', 'info');
            
            const nameServersResult = runFilterTest('name_servers_data', 'equals', 'ns1.cloudflare.com');
            addResult(`Name servers equals 'ns1.cloudflare.com': ${nameServersResult.matches}/${nameServersResult.total}`, 
                     nameServersResult.matches > 0 ? 'pass' : 'fail');
            
            const mailServersResult = runFilterTest('mail_servers_data', 'equals', 'mail.legitimate-business.com');
            addResult(`Mail servers equals 'mail.legitimate-business.com': ${mailServersResult.matches}/${mailServersResult.total}`, 
                     mailServersResult.matches > 0 ? 'pass' : 'fail');
            
            // Test 5: Boolean filters
            addResult('\\n=== Testing Boolean Filters ===', 'info');
            
            const asrmResult = runFilterTest('asrm_triggered', 'equals', 'true');
            addResult(`ASRM triggered equals 'true': ${asrmResult.matches}/${asrmResult.total}`, 
                     asrmResult.matches > 0 ? 'pass' : 'fail');
            
            // Test 6: Nested field filters
            addResult('\\n=== Testing Nested Field Filters ===', 'info');
            
            const adminCountryResult = runFilterTest('admin_contact.country', 'equals', 'us');
            addResult(`Admin country equals 'us': ${adminCountryResult.matches}/${adminCountryResult.total}`, 
                     adminCountryResult.matches > 0 ? 'pass' : 'fail');
            
            addResult('\\n=== Filter Testing Complete ===', 'info');
        }
        
        // Initialize page
        window.onload = function() {
            showFindingsData();
            runAllTests();
        };
    </script>
</body>
</html>
