<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DomainTools Monitor - Search Hashes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Include Header Component -->
        {% include 'components/header.html' %}

        <!-- Main Content -->
        <main class="main-content">
            <!-- Action Bar -->
            <div class="action-bar">
                <div class="action-group">
                    <button onclick="showAddHashModal()" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        <span>Add Hash</span>
                    </button>
                    <button onclick="showRulesModal()" class="btn btn-info">
                        <i class="fas fa-cogs"></i>
                        <span>ASRM</span>
                    </button>
                    <button onclick="showRegexGuideModal()" class="btn btn-success">
                        <i class="fas fa-code"></i>
                        <span>Regex</span>
                </button>
            </div>
            
                <div class="action-group">
                    <button onclick="forceLoadHashes()" class="btn btn-outline">
                        <i class="fas fa-sync"></i>
                        <span>Refresh</span>
                    </button>
                    <button onclick="executeFullScan()" class="btn btn-primary btn-scan">
                        <i class="fas fa-search"></i>
                        <span>Full Scan</span>
                </button>
                </div>
            </div>

            <!-- Hash Cards Grid -->
            <div class="hash-grid" id="hashGrid">
                <div class="loading-message">Loading hashes...</div>
            </div>
        </main>
    </div>

    <!-- Ultra Compact Hash Modal (from user's inspiration) -->
    <div id="hashModal" class="modal">
        <div class="modal-content ultra-compact">
            <div class="modal-header-new">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="fas fa-hashtag"></i>
                    </div>
                    <div class="header-text">
                <h2 id="modalTitle">Add Search Hash</h2>
                        <p class="header-subtitle">Create a new search pattern for monitoring</p>
                    </div>
                </div>
                <button class="close-btn-new" onclick="closeHashModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body-new">
                <form id="hashForm" class="new-hash-form">
                    <input type="hidden" id="hashId" name="hashId">
                    <div class="form-card">
                        <div class="input-section">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-tag"></i></div>
                                <div class="section-info">
                                    <label for="hashName">Hash Name</label>
                                    <span class="section-hint">Give your search pattern a descriptive name</span>
                                </div>
                            </div>
                            <div class="input-wrapper">
                                <input type="text" id="hashName" name="hashName" required placeholder="e.g., Banking Keywords, Brand Impersonation">
                            </div>
                </div>
                
                        <div class="input-section">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-search"></i></div>
                                <div class="section-info">
                                    <label for="hashValue">Search Pattern</label>
                                    <span class="section-hint">Enter keywords, phrases, or patterns to monitor</span>
                                </div>
                            </div>
                            <div class="input-wrapper">
                                <textarea id="hashValue" name="hashValue" rows="3" required placeholder="Enter search terms separated by commas&#10;Example: bank, secure, login, phishing"></textarea>
                            </div>
                </div>
                
                        <div class="input-section">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-align-left"></i></div>
                                <div class="section-info">
                    <label for="hashDescription">Description</label>
                                    <span class="section-hint">Optional details about this search pattern</span>
                                </div>
                            </div>
                            <div class="input-wrapper">
                                <textarea id="hashDescription" name="hashDescription" rows="2" placeholder="Describe what this pattern monitors and why it's important"></textarea>
                            </div>
                        </div>
                </div>
                
                    <div class="status-card">
                        <div class="status-header">
                            <div class="status-icon"><i class="fas fa-toggle-on"></i></div>
                            <div class="status-info">
                                <span class="status-title">Activation Status</span>
                                <span class="status-description">Enable or disable this search pattern</span>
                            </div>
                        </div>
                        <div class="status-control">
                            <label class="new-toggle">
                                <input type="checkbox" id="hashActive" name="hashActive" checked>
                                <div class="toggle-container">
                                    <div class="toggle-slider"></div>
                                    <div class="toggle-knob"></div>
                                </div>
                                <span class="toggle-label">Active</span>
                    </label>
                        </div>
                </div>
                
                    <div class="action-bar">
                        <button type="button" class="action-btn secondary" onclick="closeHashModal()">
                            <i class="fas fa-times"></i><span>Cancel</span>
                        </button>
                        <button type="submit" class="action-btn primary">
                            <i class="fas fa-save"></i><span>Save Hash</span>
                        </button>
                </div>
            </form>
            </div>
        </div>
    </div>

    <!-- Modern Rules Management Modal -->
    <div id="rulesModal" class="modal">
        <div class="modal-content rules-wide">
            <div class="modal-header-new">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="header-text">
                        <h2>Auto-Submission Rules Management</h2>
                        <p class="header-subtitle">Configure automated PhishLabs submission rules</p>
                    </div>
                </div>
                <button class="close-btn-new" onclick="closeRulesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body-new">
                <div class="rules-container">
                    <div class="rules-header compact-header">
                        <p>Configure automated PhishLabs submission rules based on search hash results and conditions. Rules are applied to findings and trigger auto-submission when matched.</p>
                        <div class="action-button">
                            <button onclick="showAddRuleModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                                Add New Rule
                            </button>
                        </div>
                    </div>
                    
                    <div class="rules-grid compact-grid" id="rulesList">
                        <!-- Rules will be loaded dynamically -->
                        <div class="no-rules-card">
                            <div class="no-rules-content">
                                <h4>No Auto-Submission Rules Found</h4>
                                <p>No auto-submission rules have been configured yet. Rules allow you to automatically submit findings to PhishLabs based on conditions like risk score, keywords, or other criteria.</p>
                                <p>Use the "Add New Rule" button above to create your first rule.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                
    <!-- Modern Add New Rule Modal -->
    <div id="addRuleModal" class="modal">
        <div class="modal-content rule-form">
            <div class="modal-header-new">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="header-text">
                        <h2>Add New Auto-Submission Rule</h2>
                        <p class="header-subtitle">Create a rule to automatically submit findings to PhishLabs</p>
                    </div>
                </div>
                <button class="close-btn-new" onclick="closeRuleModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body-new">
                <form id="addRuleForm" class="new-hash-form" onsubmit="saveRule(event)">
                    <!-- Basic Information Card -->
                    <div class="form-card">
                        <div class="input-section">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-info-circle"></i></div>
                                <div class="section-info">
                                    <span class="section-title">Basic Information</span>
                                    <span class="section-description">Rule name and target search hash</span>
                                </div>
                            </div>
                            <div class="input-wrapper">
                                <input type="text" id="ruleName" name="ruleName" required placeholder="e.g., High Risk Banking Domains">
                                <!-- <label for="ruleName">Rule Name *</label> -->
                            </div>
                        </div>
                        
                        <div class="input-section">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-hashtag"></i></div>
                                <div class="section-info">
                                    <span class="section-title">Target Hash</span>
                                    <span class="section-description">Select which search hash this rule applies to</span>
                                </div>
                            </div>
                            <div class="input-wrapper">
                                <select id="ruleHash" name="ruleHash" required>
                                    <option value="">Select Hash</option>
                                    <!-- Hashes will be populated dynamically -->
                                </select>
                                <!-- <label for="ruleHash">Search Hash *</label> -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- PhishLabs Case Configuration Card -->
                    <div class="form-card">
                        <div class="input-section">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-cog"></i></div>
                                <div class="section-info">
                                    <span class="section-title">PhishLabs Case Configuration</span>
                                    <span class="section-description">PhishLabs case type and brand information</span>
                                </div>
                            </div>
                            <div class="input-wrapper">
                                <select id="ruleCaseType" name="ruleCaseType" required onchange="handleCaseTypeChange()">
                                    <option value="">Select Case Type</option>
                                    <!-- Case types will be populated from PhishLabs API -->
                                </select>
                                <!-- <label for="ruleCaseType">Case Type *</label> -->
                            </div>
                        </div>
                        
                        <div class="input-section">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-building"></i></div>
                                <div class="section-info">
                                    <span class="section-title">Brand</span>
                                    <span class="section-description">Select the brand being protected</span>
                                </div>
                            </div>
                            <div class="input-wrapper">
                                <select id="ruleBrand" name="ruleBrand" required>
                                    <option value="">Select Brand</option>
                                    <!-- Brands will be populated from PhishLabs API -->
                                </select>
                                <!-- <label for="ruleBrand">Brand *</label> -->
                            </div>
                        </div>
                        
                        <div id="threatTypeGroup" class="input-section" style="display: none;">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-shield-alt"></i></div>
                                <div class="section-info">
                                    <span class="section-title">Threat Type</span>
                                    <span class="section-description">Specify the type of threat (for threat cases)</span>
                                </div>
                            </div>
                            <div class="input-wrapper">
                                <select id="ruleThreatType" name="ruleThreatType">
                                    <option value="">Select Threat Type</option>
                                    <!-- Threat types will be populated from PhishLabs API -->
                                </select>
                                <label for="ruleThreatType"></label>
                            </div>
                        </div>
                        
                        <div id="threatCategoryGroup" class="input-section" style="display: none;">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-exclamation-triangle"></i></div>
                                <div class="section-info">
                                    <span class="section-title">Threat Category</span>
                                    <span class="section-description">Specify the category of threat (for domain cases)</span>
                                </div>
                            </div>
                            <div class="input-wrapper">
                                <select id="ruleThreatCategory" name="ruleThreatCategory">
                                    <option value="">Select Threat Category</option>
                                    <!-- Threat categories will be populated from constants -->
                                </select>
                                <label for="ruleThreatCategory"></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tagging Configuration Card -->
                    <div class="form-card">
                        <div class="input-section">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-tags"></i></div>
                                <div class="section-info">
                                    <span class="section-title">Auto-Tagging Configuration</span>
                                    <span class="section-description">Automatically tag findings when this rule submits them to PhishLabs</span>
                                </div>
                            </div>
                            
                            <div class="checkbox-container">
                                <input type="checkbox" id="ruleEnableTagging" name="ruleEnableTagging" onchange="toggleRuleTagging()">
                                <label for="ruleEnableTagging" class="checkbox-label">Enable Auto-Tagging</label>
                            </div>
                            
                            <div id="ruleTaggingField" style="display: none;">
                                <div class="input-wrapper">
                                    <select id="ruleTagSelect" name="ruleTagSelect" onchange="handleRuleTagSelection()">
                                        <option value="">Select existing tag or create new...</option>
                                        <option value="__new__">+ Create New Tag</option>
                                        <!-- Tags will be populated dynamically -->
                                    </select>
                                </div>
                                
                                <div id="ruleNewTagField" style="display: none;">
                                    <div class="input-wrapper">
                                        <input type="text" id="ruleNewTag" name="ruleNewTag" placeholder="Enter new tag name">
                                        <button type="button" class="btn btn-sm btn-primary" onclick="createRuleTag()">
                                            Create Tag
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Rule Conditions Card -->
                    <div class="form-card">
                        <div class="input-section">
                            <div class="section-header">
                                <div class="section-icon"><i class="fas fa-filter"></i></div>
                                <div class="section-info">
                                    <span class="section-title">Rule Conditions</span>
                                    <span class="section-description">Define when this rule should trigger auto-submission</span>
                                </div>
                            </div>
                            <div class="conditions-builder">
                                <div class="conditions-header">
                                    <button type="button" onclick="addCondition()" class="action-btn secondary">
                                        <i class="fas fa-plus"></i><span>Add Condition</span>
                                    </button>
                                </div>
                                
                                <div id="conditionsContainer" class="conditions-container">
                                    <!-- Conditions will be added dynamically -->
                                    <div class="no-conditions-message">
                                        <i class="fas fa-info-circle"></i>
                                        <span>No conditions added yet. Click "Add Condition" to define when this rule should trigger.</span>
                                    </div>
                                </div>
                                
                                <div class="conditions-help">
                                    <i class="fas fa-lightbulb"></i>
                                    <span>Conditions determine when findings are automatically submitted to PhishLabs. Each condition includes AND/OR logic to connect with the previous condition. For multiple values, separate with commas.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-bar">
                        <button type="button" class="action-btn secondary" onclick="closeAddRuleModal()">
                            <i class="fas fa-times"></i><span>Cancel</span>
                        </button>
                        <button type="submit" class="action-btn primary">
                            <i class="fas fa-save"></i><span>Save Rule</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Regex Guide Modal -->
    <div id="regexGuideModal" class="modal">
        <div class="modal-content rules-wide">
            <div class="modal-header-new">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="header-text">
                        <h2>ASRM Regex Pattern Guide</h2>
                        <p class="header-subtitle">Master regex patterns for creating powerful ASRM rules</p>
                    </div>
                </div>
                <button class="close-btn-new" onclick="closeRegexGuideModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body-new">
                <div class="rules-container">
                    <!-- Quick Reference -->
                    <!-- <div class="quick-ref-section">
                        <h3><i class="fas fa-bolt"></i> Quick Reference</h3>
                        <div class="quick-ref-grid">
                            <div class="quick-ref-item">
                                <strong>Any Character</strong>
                                <code>.</code>
                            </div>
                            <div class="quick-ref-item">
                                <strong>Start of String</strong>
                                <code>^</code>
                            </div>
                            <div class="quick-ref-item">
                                <strong>End of String</strong>
                                <code>$</code>
                            </div>
                            <div class="quick-ref-item">
                                <strong>Zero or More</strong>
                                <code>*</code>
                            </div>
                            <div class="quick-ref-item">
                                <strong>One or More</strong>
                                <code>+</code>
                            </div>
                            <div class="quick-ref-item">
                                <strong>OR Operator</strong>
                                <code>|</code>
                            </div>
                        </div>
                    </div> -->

                    <!-- Basic Characters Table -->
                    <div class="section">
                        <h3><i class="fas fa-keyboard"></i> Basic Regex Characters</h3>
                        <div class="table-responsive">
                            <table class="regex-table">
                                <thead>
                                    <tr>
                                        <th>Character</th>
                                        <th>Meaning</th>
                                        <th>Example</th>
                                        <th>Matches</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>.</code></td>
                                        <td>Any character (except newline)</td>
                                        <td><code>b.t</code></td>
                                        <td><code>bat</code>, <code>bit</code>, <code>bot</code></td>
                                    </tr>
                                    <tr>
                                        <td><code>^</code></td>
                                        <td>Start of string</td>
                                        <td><code>^bitcoin</code></td>
                                        <td><code>bitcoin-trading.com</code> ✅</td>
                                    </tr>
                                    <tr>
                                        <td><code>$</code></td>
                                        <td>End of string</td>
                                        <td><code>\.com$</code></td>
                                        <td><code>example.com</code> ✅</td>
                                    </tr>
                                    <tr>
                                        <td><code>*</code></td>
                                        <td>Zero or more of preceding</td>
                                        <td><code>bitcoin*</code></td>
                                        <td><code>bitcoi</code>, <code>bitcoin</code></td>
                                    </tr>
                                    <tr>
                                        <td><code>+</code></td>
                                        <td>One or more of preceding</td>
                                        <td><code>bitcoin+</code></td>
                                        <td><code>bitcoin</code>, <code>bitcoinnnn</code></td>
                                    </tr>
                                    <tr>
                                        <td><code>|</code></td>
                                        <td>OR operator</td>
                                        <td><code>bitcoin|crypto</code></td>
                                        <td><code>bitcoin</code> OR <code>crypto</code></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Common ASRM Patterns -->
                    <div class="section">
                        <h3><i class="fas fa-shield-alt"></i> Common ASRM Patterns</h3>
                        <div class="pattern-grid">
                            <div class="pattern-card">
                                <h4>Phishing Detection</h4>
                                <div class="pattern-code">.*(paypal|apple|microsoft|google|amazon).*</div>
                                <p>Detects brand impersonation domains</p>
                            </div>
                            <div class="pattern-card">
                                <h4>Login Pages</h4>
                                <div class="pattern-code">.*(login|sign.?in|account|verify).*</div>
                                <p>Matches login-related titles and domains</p>
                            </div>
                            <div class="pattern-card">
                                <h4>Cryptocurrency Scams</h4>
                                <div class="pattern-code">.*(bitcoin|crypto|ethereum).*(investment|trading|profit).*</div>
                                <p>Detects crypto investment scams</p>
                            </div>
                            <div class="pattern-card">
                                <h4>Malware Distribution</h4>
                                <div class="pattern-code">.*(download|software|crack|keygen).*</div>
                                <p>Identifies software download sites</p>
                            </div>
                            <div class="pattern-card">
                                <h4>Suspicious Domains</h4>
                                <div class="pattern-code">.*[a-z]{10,}.*|.*[0-9]{4,}.*</div>
                                <p>Detects random character domains</p>
                            </div>
                            <div class="pattern-card">
                                <h4>Urgent Actions</h4>
                                <div class="pattern-code">.*(urgent|immediate|action|required|update).*</div>
                                <p>Matches urgent action keywords</p>
                            </div>
                        </div>
                    </div>

                    <!-- Character Classes -->
                    <div class="section">
                        <h3><i class="fas fa-layer-group"></i> Character Classes</h3>
                        <div class="table-responsive">
                            <table class="regex-table">
                                <thead>
                                    <tr>
                                        <th>Pattern</th>
                                        <th>Meaning</th>
                                        <th>Example</th>
                                        <th>Matches</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>[abc]</code></td>
                                        <td>Any of a, b, c</td>
                                        <td><code>[abc]itcoin</code></td>
                                        <td><code>aitcoin</code>, <code>bitcoin</code>, <code>citcoin</code></td>
                                    </tr>
                                    <tr>
                                        <td><code>[^abc]</code></td>
                                        <td>Not a, b, c</td>
                                        <td><code>[^abc]itcoin</code></td>
                                        <td><code>ditcoin</code>, <code>eitcoin</code></td>
                                    </tr>
                                    <tr>
                                        <td><code>[a-z]</code></td>
                                        <td>Any lowercase letter</td>
                                        <td><code>[a-z]itcoin</code></td>
                                        <td><code>aitcoin</code>, <code>bitcoin</code></td>
                                    </tr>
                                    <tr>
                                        <td><code>\d</code></td>
                                        <td>Any digit</td>
                                        <td><code>\d+</code></td>
                                        <td><code>123</code>, <code>456789</code></td>
                                    </tr>
                                    <tr>
                                        <td><code>\w</code></td>
                                        <td>Word character</td>
                                        <td><code>\w+</code></td>
                                        <td><code>bitcoin</code>, <code>crypto123</code></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Best Practices -->
                    <div class="section">
                        <h3><i class="fas fa-star"></i> Best Practices</h3>
                        <div class="best-practices">
                            <div class="practice-item success">
                                <h4>✅ Keep Patterns Simple</h4>
                                <div class="code-example">
                                    <strong>Good:</strong> <code>.*(bitcoin|crypto).*</code><br>
                                    <strong>Avoid:</strong> <code>.*(bitcoin|crypto|ethereum|binance|coinbase|wallet|trading|investment|profit|returns|guaranteed|free|no.risk|100%.*return).*</code>
                                </div>
                            </div>
                            <div class="practice-item success">
                                <h4>✅ Use Specific Patterns</h4>
                                <div class="code-example">
                                    <strong>Good:</strong> <code>.*(login|sign.?in|account|verify).*</code><br>
                                    <strong>Avoid:</strong> <code>.*(login|account).*</code>
                                </div>
                            </div>
                            <div class="practice-item warning">
                                <h4>⚠️ Don't Use Anchors for Contains Logic</h4>
                                <div class="code-example">
                                    <strong>Wrong:</strong> <code>^bitcoin</code><br>
                                    <strong>Correct:</strong> <code>bitcoin</code>
                                </div>
                            </div>
                            <div class="practice-item warning">
                                <h4>⚠️ Escape Special Characters</h4>
                                <div class="code-example">
                                    <strong>Wrong:</strong> <code>.com</code><br>
                                    <strong>Correct:</strong> <code>\.com</code>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Testing Section -->
                    <div class="section testing-section">
                        <h3><i class="fas fa-flask"></i> Testing Your Patterns</h3>
                        <p>Use our built-in regex validator to test your patterns before using them in ASRM rules:</p>
                        <div class="test-command">
                            <code>python regex_validator.py</code>
                        </div>
                        <div class="test-command">
                            <code>python regex_validator.py ".*(bitcoin|crypto).*" domain_keywords</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Modal -->
    {% include 'components/system_status_toast.html' %}

    <!-- Toast Notification -->
    <div id="notification" class="notification"></div>

      <!-- DTMonitor Modular JavaScript Framework -->
    <script src="{{ url_for('static', filename='js/dtmonitor-core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dtmonitor-api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dtmonitor-scanning.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dtmonitor-settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dtmonitor-findings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dtmonitor-hash.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dtmonitor-compat.js') }}"></script>
</body>
</html>